# Sparrow SPOT v8.6.1 - Pre-Fix Snapshot
## Status Lock - December 9, 2025

### Overview
This document captures the exact state of code before bug fixes are applied.
Purpose: Track changes, ensure rollback capability, document baseline.

---

## üîç CURRENT STATE ANALYSIS

### File: `/home/gene/Sparrow-SPOT-Policy/narrative_integration.py`

#### Lines 142-147 (Step 2.1 - Narrative Expansion)
```python
# Step 2.1: Fix #5 - Expand narrative with Ollama for longer formats
if length in ['detailed', 'comprehensive'] and ollama_model:
    print(f"üîÑ Step 2.1: Expanding narrative with {ollama_model}...")
    narrative_text = self._expand_narrative_with_ollama(
        narrative_text, analysis, length, ollama_model
    )
```

**STATUS:** ‚úÖ **ALREADY FIXED!**
- The function call IS present
- Assignment IS happening correctly
- Code looks correct

**IMPLICATION:** The expansion logic is in place. The issue must be elsewhere.

---

## üîé ROOT CAUSE ANALYSIS

Since the function call is correct, the problem must be one of:

### Hypothesis 1: The expansion function isn't executing
**Reason:** Condition might not be met
```python
if length in ['detailed', 'comprehensive'] and ollama_model:
```
- Check: Is `length` actually 'comprehensive'?
- Check: Is `ollama_model` actually passed and not None?

### Hypothesis 2: Ollama connection failing silently
**Location:** `_expand_narrative_with_ollama()` at line 497
**Current behavior:** Has try-except that catches errors
```python
except requests.exceptions.RequestException as e:
    print(f"   ‚ö†Ô∏è Ollama expansion error: {e}")
    return narrative_text  # Returns original unexp

anded
```
**Issue:** If Ollama fails, it silently returns original 450-word narrative
**Result:** User doesn't know expansion was attempted

### Hypothesis 3: Narrative expansion is running but producing only 450 words
**Issue:** The Ollama prompt might be weak
**Check:** Is Ollama returning correct word count?

### Hypothesis 4: Meta-note is appended after successful expansion
**Location:** Unknown (need to search)
**Issue:** Even if expansion works to 3500 words, meta-note saying "450 words" gets appended
**Result:** User sees conflicting information

---

## üìä VERSION INFO

```
Version: v8.6.1
Date: December 9, 2025
Variant: SPOT-Policy‚Ñ¢
Engine: Narrative Engine + Tone Adaptor

Key Components:
- narrative_integration.py: v8.6.1 (main orchestrator)
- narrative_engine.py: Generates components
- tone_adaptor.py: Adapts to tone + length
- enhanced_document_qa.py: Chunking Q&A
```

---

## üîß TOOLS & DEPENDENCIES

### Expansion Dependencies
- `requests` library (HTTP to Ollama)
- Ollama server running on `http://localhost:11434`
- Model parameter passed correctly

### Available Models Tested
- granite4:tiny-h (small, fast)
- mistral (medium)
- llama3.2 (larger)

---

## üìù ACTUAL ISSUE OBSERVED

User reported:
```
Narrative Length Selected: "comprehensive" (3500+ words expected)
Actual Output: ~450 words
Meta-note: "This expanded narrative is approximately 450 words. To reach the 
            desired length of approximately 3500 words..."
```

**Evidence:**
- File: `/home/gene/Sparrow-SPOT-Policy/Investigations/Bill-C-15/Bill-C15-00/narrative/Bill-C15-00_publish.md`
- Shows meta-note confirming expansion did NOT occur

---

## ‚úÖ TODOS UPDATED

Based on actual code state:

### **TODO #1: REVISE** 
Original: "Fix missing function call"
**Status:** Function call IS present and correct
**New action:** Investigate WHY expansion function isn't producing desired output

### **TODO #2-7: Still valid**
- Error handling still needed
- Debugging output still needed
- Meta-note behavior needs fixing
- Timeout review needed
- Token safeguard needed
- End-to-end testing needed

---

## üîç NEXT INVESTIGATION STEPS

Before applying fixes, we need to:

1. **Check if condition is met:**
   - Add debugging to confirm `length == 'comprehensive'`
   - Confirm `ollama_model` is not None
   - Print values before expansion call

2. **Check if Ollama is responding:**
   - Add logging to Ollama request
   - Check response payload
   - Verify model is returning expected tokens

3. **Check meta-note location:**
   - Search for "approximately 450 words" text
   - Understand when/where it's appended
   - Is it always added? Only on failure?

4. **Verify word count calculation:**
   - How is "450 words" calculated?
   - Is the returned narrative really 450 words?
   - Or is meta-note counted as part of narrative?

---

## üìã REVISED TODO LIST

1. **Add comprehensive debugging** (high priority)
   - Log length parameter value
   - Log ollama_model parameter value
   - Log expansion function entry/exit
   - Log returned narrative length
   - Log Ollama request/response

2. **Investigate meta-note**
   - Find where it's generated/appended
   - Understand conditions
   - Determine if it's the issue

3. **Test Ollama connection**
   - Verify Ollama is accessible
   - Test direct request to expansion endpoint
   - Verify model parameters

4. **Review expansion prompt**
   - Check if Ollama prompt is effective
   - Verify token budget (`num_predict: target_words * 2`)
   - Check temperature and other parameters

---

## üéØ DISCOVERY PLAN

**Phase 1: Debug (30 minutes)**
```
1. Add print statements to narrative_integration.py around expansion call
2. Run analysis with comprehensive narrative
3. Check logs to see if:
   - Expansion condition is met
   - Function is actually called
   - Ollama request is sent
   - Response is received
4. Compare request/response
```

**Phase 2: Fix (60 minutes)**
```
Based on Phase 1 findings:
- If condition not met ‚Üí Check parameter passing
- If Ollama fails ‚Üí Better error handling
- If prompt weak ‚Üí Improve prompt
- If meta-note issue ‚Üí Fix appending logic
```

**Phase 3: Validate (30 minutes)**
```
- Test comprehensive narrative generation
- Verify word count
- Confirm meta-note behavior
- Document results
```

---

## üìå KEY FILES TO MONITOR

```
/home/gene/Sparrow-SPOT-Policy/
‚îú‚îÄ‚îÄ narrative_integration.py (lines 142-147, 495-650)
‚îú‚îÄ‚îÄ tone_adaptor.py (lines 62-160)
‚îî‚îÄ‚îÄ Investigations/Bill-C-15/Bill-C15-00/
    ‚îî‚îÄ‚îÄ narrative/
        ‚îî‚îÄ‚îÄ Bill-C15-00_publish.md (where output appears)
```

---

## ‚ö†Ô∏è IMPORTANT NOTES

1. **Expansion function EXISTS and is CALLED** - Not missing code
2. **Issue is in EXECUTION** - Function runs but doesn't produce expected output
3. **Meta-note is MISLEADING** - Says expansion failed when it might just be weak
4. **Need DEBUG DATA** - Can't fix without understanding what's happening

---

## üîê LOCK CONFIRMATION

**Current Version:** v8.6.1  
**Snapshot Date:** 2025-12-09  
**Status:** Ready for debugging  
**Rollback Point:** Established  

**Next Action:** Add debugging to understand actual behavior before fixing
